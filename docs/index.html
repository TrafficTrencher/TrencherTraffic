// Trencher Traffic â€” app.js (FULL, with fixed countdown to Feb 2, 2026 3:00 PM EST)

const GOAL_MILES = 50000;
const CLAIMS_TOTAL = 25;
const STEP = GOAL_MILES / CLAIMS_TOTAL; // 2000

// Feb 2, 2026 @ 3:00 PM EST = Feb 2, 2026 @ 20:00 UTC
const TARGET_UTC_MS = Date.UTC(2026, 1, 2, 20, 0, 0);

const $ = (id) => document.getElementById(id);

function fmt(n) {
  const x = Math.max(0, Math.floor(Number(n) || 0));
  return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
}

function clampMiles(n) {
  return Math.max(0, Math.min(GOAL_MILES, Math.floor(Number(n) || 0)));
}

/* ---------------- LIVE BADGE ---------------- */
function setLiveBadge(isLive) {
  const badge = $("liveBadge");
  if (!badge) return;
  if (isLive) badge.classList.add("is-live");
  else badge.classList.remove("is-live");
}

function setStream(url) {
  const frame = $("streamFrame");
  if (frame) frame.src = url || "";
  setLiveBadge(Boolean(url && url.trim().length > 5));
}

/* ---------------- MILESTONES ---------------- */
function buildMilestones(current) {
  const list = $("milestoneList");
  if (!list) return;

  list.innerHTML = "";

  for (let i = 1; i <= CLAIMS_TOTAL; i++) {
    const mileMark = i * STEP;

    const li = document.createElement("li");
    li.style.margin = "10px 0";
    li.style.padding = "10px 12px";
    li.style.border = "1px solid rgba(255,255,255,.10)";
    li.style.borderRadius = "12px";
    li.style.display = "flex";
    li.style.justifyContent = "space-between";
    li.style.alignItems = "center";
    li.style.background = "rgba(255,255,255,.02)";

    const left = document.createElement("div");
    left.innerHTML = `<b>Claim ${i}</b><div style="font-size:12px;color:#a8b3d1">${fmt(mileMark)} miles</div>`;

    const tag = document.createElement("div");
    const done = current >= mileMark;
    tag.textContent = done ? "DONE" : "PENDING";
    tag.style.fontSize = "12px";
    tag.style.fontWeight = "800";
    tag.style.padding = "6px 10px";
    tag.style.borderRadius = "999px";
    tag.style.border = "1px solid rgba(255,255,255,.10)";
    tag.style.color = done ? "#07101a" : "#a8b3d1";
    tag.style.background = done
      ? "linear-gradient(135deg,#7c5cff,#00d4ff)"
      : "rgba(255,255,255,.03)";

    li.appendChild(left);
    li.appendChild(tag);
    list.appendChild(li);
  }
}

function updateMilesUI(current) {
  const pct = Math.round((current / GOAL_MILES) * 1000) / 10;

  const currentMilesText = $("currentMilesText");
  const percentText = $("percentText");
  const barFill = $("barFill");

  if (currentMilesText) currentMilesText.textContent = fmt(current);
  if (percentText) percentText.textContent = `${pct}%`;
  if (barFill) barFill.style.width = `${Math.min(100, (current / GOAL_MILES) * 100)}%`;

  buildMilestones(current);
}

/* ---------------- COUNTDOWN ---------------- */
function formatDuration(ms) {
  const total = Math.max(0, Math.floor(ms / 1000));
  const days = Math.floor(total / 86400);
  const hrs = Math.floor((total % 86400) / 3600);
  const mins = Math.floor((total % 3600) / 60);
  const secs = total % 60;

  const dd = days > 0 ? `${days}d ` : "";
  const hh = `${hrs}h `;
  const mm = `${mins}m `;
  const ss = `${secs}s`;
  return (dd + hh + mm + ss).trim();
}

function updateCountdown() {
  const el = $("countdown");
  if (!el) return;

  const now = Date.now();
  const diff = TARGET_UTC_MS - now;

  if (diff <= 0) {
    el.innerHTML = `ðŸš€ Stream time! <small>(Feb 2 â€¢ 3:00 PM EST)</small>`;
    return;
  }

  el.innerHTML = `Countdown to Feb 2 â€¢ 3:00 PM EST <small>(in ${formatDuration(diff)})</small>`;
}

/* ---------------- INIT ---------------- */
function init() {
  // Footer year
  const yearEl = $("year");
  if (yearEl) yearEl.textContent = new Date().getFullYear();

  // Load saved values
  const savedStream = (localStorage.getItem("tt_stream_url") || "").trim();
  const savedMiles = clampMiles(localStorage.getItem("tt_miles") || 0);

  const streamUrlInput = $("streamUrl");
  const currentMilesInput = $("currentMiles");

  if (streamUrlInput) streamUrlInput.value = savedStream;
  if (currentMilesInput) currentMilesInput.value = savedMiles ? String(savedMiles) : "";

  setStream(savedStream);
  updateMilesUI(savedMiles);

  // Save stream
  const saveStreamBtn = $("saveStream");
  if (saveStreamBtn) {
    saveStreamBtn.addEventListener("click", () => {
      const url = (streamUrlInput?.value || "").trim();
      localStorage.setItem("tt_stream_url", url);
      setStream(url);
    });
  }

  // Save miles
  const saveMilesBtn = $("saveMiles");
  if (saveMilesBtn) {
    saveMilesBtn.addEventListener("click", () => {
      const m = clampMiles(currentMilesInput?.value || 0);
      localStorage.setItem("tt_miles", String(m));
      updateMilesUI(m);
    });
  }

  // Countdown ticker
  updateCountdown();
  setInterval(updateCountdown, 1000);
}

// Run after DOM is ready (extra-safe)
document.addEventListener("DOMContentLoaded", init);
